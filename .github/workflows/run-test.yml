name: Run windows tests

on:
  workflow_call:
    inputs:
      test-executable-name:
        required: true
        type: string

jobs:
  test-common-Windows:
    runs-on: [ self-hosted, Windows ]
    env:
      KDRIVE_TEST_CI_8MO_PARTITION_PATH: ${{ vars.KDRIVE_TEST_CI_8MO_PARTITION_PATH_WIN }}
    steps:
      - name: Load system Path into Github environment
        run : echo Path=%Path%>> %GITHUB_ENV%
        shell: cmd

      - name: Checkout the PR
        uses: actions/checkout@v4.1.1
        with:
          ref: ${{ github.head_ref }}

      - name: Clean up log directory
        run: powershell -ExecutionPolicy Bypass -Command "if (Test-Path '$env:TEMP\kDrive-logdir') { Remove-Item -Path '$env:TEMP\kDrive-logdir\*' -Recurse -Force }"

      - name: Load cached dependencies
        id: cache
        uses: herve-er/local-cache@v2
        with:
          path: build-windows/cache
          base: ${{ github.workspace }}/../local-cache
          key: ${{ vars.KDRIVE_TEST_DEPENDENCIES_VERSION }}
          clean-key: true        

      - name: Download common files
        if: steps.cache.outputs.cache-hit != 'true'
        uses: actions/download-artifact@v4
        with:
          name: windows-build-common-files
          path: ${{ github.workspace }}/build-windows/cache/

      - name: Download qt libs
        if: steps.cache.outputs.cache-hit != 'true'
        uses: actions/download-artifact@v4
        with:
          name: windows-build-qt-libs
          path: ${{ github.workspace }}/build-windows/cache/

      - name: Copy the cache to the test directory
        run: cp -r ${{ github.workspace }}/build-windows/cache/ ${{ github.workspace }}/build-windows/test/

      - name: Download test executable
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.test-executable-name }}
          path: ${{ github.workspace }}/build-windows/test/

      - name: Execute tests
        run: powershell ./infomaniak-build-tools/run-test.ps1 ./build-windows/test/ ${{ inputs.test-executable-name }}.exe

      - name: Copy logs to workspace
        run: |
            $logSource = "$env:TEMP\kDrive-logdir"
            $logDest = "${{ github.workspace }}\build-windows\logs"

            if (Test-Path $logSource) {
              New-Item -ItemType Directory -Force -Path $logDest | Out-Null
              Copy-Item -Path "$logSource\*" -Destination $logDest -Recurse -Force
            } else {
              Write-Output "No logs found to copy."
            }
        if: always()

      - name: Upload tests logs artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-logs-$test-executable-name
          path: ${{ github.workspace }}\build-windows\logs\*
          retention-days: 1
        if: always()

      - name: Clean up
        run : rm -r -force ${{ github.workspace }}/build-windows/test/