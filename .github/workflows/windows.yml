name: Windows kDrive desktop CI

on:
  pull_request:

concurrency:
  group: ${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  build-kDrive:
    runs-on: [ self-hosted, Windows, desktop-kdrive ]

    steps:
      - name: Checkout the PR
        uses: actions/checkout@v4.1.1
        with:
          submodules: recursive

      - name: Restore extension packages
        run : nuget restore extensions/windows/cfapi/kDriveExt.sln

      - name: Build kDrive desktop
        run : |
          call "C:/Program Files (x86)/Microsoft Visual Studio/2019/Community/VC/Auxiliary/Build/vcvars64.bat"
          powershell ./infomaniak-build-tools/windows/build-drive.ps1 -ci
        shell: cmd

      - name: Clean-up generated code
        run : powershell ./infomaniak-build-tools/windows/build-drive.ps1 -clean all
